{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="mb-10">
        <h1 class="text-3xl font-bold text-brand-primary mb-2">
            Doctor Dashboard
        </h1>
        <p class="text-textc-muted">
            Manage your appointments and patient care
        </p>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
        {% for stat in "1234"|make_list %}
        <div class="card-style p-6 transition-all hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    {# ================================================================== #}
                    {# STAT CARD LABELS: Different labels for each card based on loop index #}
                    {# forloop.counter == 1: Total Appointments (all time count) #}
                    {# forloop.counter == 2: Pending (appointments awaiting approval) #}
                    {# forloop.counter == 3: Completed (successfully finished appointments) #}
                    {# forloop.counter == 4: Today's Appointments (scheduled for today) #}
                    {# ================================================================== #}
                    {% if forloop.counter == 1 %}
                    <p class="text-textc-muted text-sm">Total Appointments</p>
                    <p class="text-2xl font-bold text-textc-main">{{ total_appointments }}</p>
                    {% elif forloop.counter == 2 %}
                    <p class="text-textc-muted text-sm">Pending</p>
                    <p class="text-2xl font-bold text-brand-warning">{{ pending_appointments }}</p>
                    {% elif forloop.counter == 3 %}
                    <p class="text-textc-muted text-sm">Completed</p>
                    <p class="text-2xl font-bold text-brand-success">{{ completed_appointments }}</p>
                    {% else %}
                    <p class="text-textc-muted text-sm">Today's Appointments</p>
                    <p class="text-2xl font-bold text-brand-primary">{{ todays_appointments }}</p>
                    {% endif %}
                </div>
                <div class="w-12 h-12 rounded-xl bg-brand-primary/10 flex items-center justify-center">
                    <i class="fas fa-chart-line text-brand-primary"></i>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

        <!-- Appointments -->
        <div class="lg:col-span-3">
            <div class="card-style">

                <div class="p-6 border-b border-brand-accent flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-textc-main">Appointment Management</h2>

                    <div class="flex space-x-3">
                        <select id="statusFilter"
                            class="bg-brand-surface border border-brand-accent rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-brand-primary text-textc-main">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>

                        <div class="relative">
                            <input id="searchInput" placeholder="Search patients..."
                                class="bg-brand-surface border border-brand-accent rounded-xl pl-10 pr-4 py-2 text-sm w-64 focus:outline-none focus:border-brand-primary text-textc-main">
                            <i class="fas fa-search absolute left-3 top-3 text-textc-muted text-sm"></i>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    {% if appointments %}
                    <div class="space-y-4" id="appointmentsList">

                        {% for appointment in appointments %}
                        <div class="appointment-item bg-brand-surface rounded-xl p-4 border border-brand-accent transition-all hover:-translate-y-0.5"
                            data-id="{{ appointment.id }}"
                            data-status="{{ appointment.status }}"
                            data-search="{{ appointment.patient_name|lower }} {{ appointment.reason|lower }}">

                            <div class="flex justify-between">
                                <div class="flex-1">

                                    <div class="flex flex-wrap gap-2 mb-2">
                                        <h3 class="font-semibold text-textc-main">{{ appointment.patient_name }}</h3>

                                        {# Status badge showing current appointment status #}
                                        <span class="px-2 py-1 rounded-full text-xs {% if appointment.status == 'pending' %}bg-brand-warning/10 text-brand-warning{% elif appointment.status == 'approved' %}bg-blue-100 text-blue-600{% elif appointment.status == 'scheduled' %}bg-brand-success/10 text-brand-success{% elif appointment.status == 'completed' %}bg-gray-100 text-gray-600{% elif appointment.status == 'cancelled' %}bg-brand-danger/10 text-brand-danger{% elif appointment.status == 'no_show' %}bg-orange-100 text-orange-600{% elif appointment.status == 'rejected' %}bg-red-100 text-red-600{% elif appointment.status == 'rescheduled' %}bg-purple-100 text-purple-600{% else %}bg-brand-primary/10 text-brand-primary{% endif %}">
                                            {{ appointment.get_status_display }}
                                        </span>

                                        {# Priority badge showing appointment priority level #}
                                        <span
                                            class="px-2 py-1 rounded-full text-xs bg-brand-warning/10 text-brand-warning">
                                            {{ appointment.get_priority_display }}
                                        </span>
                                    </div>

                                    <p class="text-sm text-textc-muted">
                                        <i class="far fa-calendar mr-1"></i>
                                        {{ appointment.appointment_date }} at {{ appointment.appointment_time }}
                                    </p>

                                    <p class="text-sm text-textc-muted">
                                        <i class="far fa-envelope mr-1"></i>
                                        {{ appointment.patient_email }}
                                    </p>

                                    {# Conditional display: Show phone only if available #}
                                    {% if appointment.patient_phone %}
                                    <p class="text-sm text-textc-muted">
                                        <i class="fas fa-phone mr-1"></i>
                                        {{ appointment.patient_phone }}
                                    </p>
                                    {% endif %}

                                    {# Conditional display: Show reason only if provided #}
                                    {% if appointment.reason %}
                                    <p class="mt-2 text-sm text-textc-main">
                                        <span class="text-textc-muted">Reason:</span>
                                        {{ appointment.reason|truncatechars:100 }}
                                    </p>
                                    {% endif %}
                                </div>

                                <!-- Actions -->
                                <div class="flex flex-col space-y-2 ml-4">
                                    {# ========================================================================== #}
                                    {# STATUS-BASED ACTION BUTTONS: Different actions based on appointment status #}
                                    {# ========================================================================== #}
                                    {# PENDING: Can be approved or rejected by doctor #}
                                    {% if appointment.status == 'pending' %}
                                    <button onclick="updateStatus({{ appointment.id }}, 'approved')"
                                        class="px-3 py-1 rounded-lg bg-brand-success/80 hover:bg-brand-success text-white transition">
                                        Approve
                                    </button>
                                    <button onclick="updateStatus({{ appointment.id }}, 'rejected')"
                                        class="px-3 py-1 rounded-lg bg-brand-danger/80 hover:bg-brand-danger text-white transition">
                                        Reject
                                    </button>
                                    {# APPROVED: Can be scheduled with specific date/time #}
                                    {% elif appointment.status == 'approved' %}
                                    <button onclick="updateStatus({{ appointment.id }}, 'scheduled')"
                                        class="px-3 py-1 rounded-lg btn-primary transition">
                                        Schedule
                                    </button>
                                    {# SCHEDULED: Can be marked as completed or no-show #}
                                    {% elif appointment.status == 'scheduled' %}
                                    <button onclick="updateStatus({{ appointment.id }}, 'completed')"
                                        class="px-3 py-1 rounded-lg bg-brand-success hover:bg-brand-success/90 text-white transition">
                                        Complete
                                    </button>
                                    <button onclick="updateStatus({{ appointment.id }}, 'no_show')"
                                        class="px-3 py-1 rounded-lg bg-gray-500 hover:bg-gray-400 text-white transition">
                                        No Show
                                    </button>
                                    {% endif %}

                                    {# Always available: View appointment details #}
                                    <button onclick="viewDetails({{ appointment.id }})"
                                        class="px-3 py-1 rounded-lg bg-brand-accent text-brand-primary hover:bg-brand-accent/80 transition">
                                        Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    {# Empty state: Show when no appointments exist #}
                    <p class="text-center text-textc-muted py-10">No appointments found</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="lg:col-span-1 space-y-6">

            <!-- Notifications -->
            <div class="card-style">
                <div class="p-6 border-b border-brand-accent flex justify-between">
                    <h2 class="font-semibold text-textc-main">Notifications</h2>
                    <button onclick="markAllRead()" class="text-brand-primary text-sm">
                        Mark all
                    </button>
                </div>

                <div class="p-6 space-y-4">
                    {# Check if user has any notifications #}
                    {% if notifications %}
                    {# Loop through notifications and display each #}
                    {% for notification in notifications %}
                    <div class="p-3 rounded-xl bg-brand-surface border border-brand-accent">
                        <h4 class="text-sm font-medium text-textc-main">{{ notification.title }}</h4>
                        <p class="text-xs text-textc-muted mt-1">{{ notification.message }}</p>
                    </div>
                    {% endfor %}
                    {% else %}
                    {# Empty state: Show when no notifications exist #}
                    <p class="text-textc-muted text-sm text-center">No notifications</p>
                    {% endif %}
                </div>
            </div>

            <!-- Profile -->
            <div class="card-style p-6 text-center">
                <div class="w-16 h-16 mx-auto rounded-full bg-brand-primary/10 flex items-center justify-center mb-3">
                    <i class="fas fa-user-md text-brand-primary text-xl"></i>
                </div>
                <h3 class="font-semibold text-textc-main">{{ user.username }}</h3>
                <p class="text-textc-muted text-sm">{{ doctor.specialization }}</p>
                <p class="text-xs text-textc-muted/70">{{ doctor.experience_years }} years experience</p>

                <div class="mt-4 space-y-2">
                    <a href="#"
                        class="block px-4 py-2 rounded-xl bg-brand-accent text-brand-primary hover:bg-brand-accent/80 transition text-sm">
                        <i class="fas fa-user mr-1"></i> Edit Profile
                    </a>
                    <a href="{% url 'manage_availability' %}"
                        class="block px-4 py-2 rounded-xl bg-brand-accent text-brand-primary hover:bg-brand-accent/80 transition text-sm">
                        <i class="fas fa-clock mr-1"></i> Availability
                    </a>
                    <a href="{% url 'appointment_calendar' %}"
                        class="block px-4 py-2 rounded-xl bg-brand-accent text-brand-primary hover:bg-brand-accent/80 transition text-sm">
                        <i class="fas fa-calendar-alt mr-1"></i> Calendar
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
  // Initialize filter and search on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Set up status filter listener
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
      statusFilter.addEventListener('change', filterAppointments);
    }

    // Set up search listener
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', filterAppointments);
    }
  });

  // Filter appointments based on status and search
  function filterAppointments() {
    const statusFilter = document.getElementById('statusFilter').value;
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
    const appointmentItems = document.querySelectorAll('.appointment-item');

    appointmentItems.forEach(item => {
      const itemStatus = item.getAttribute('data-status');
      const itemSearch = item.getAttribute('data-search') || '';
      
      const matchesStatus = !statusFilter || itemStatus === statusFilter;
      const matchesSearch = !searchQuery || itemSearch.includes(searchQuery);

      if (matchesStatus && matchesSearch) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  }

  // Update appointment status
  async function updateStatus(appointmentId, newStatus) {
    const statusMessages = {
      'approved': 'approve',
      'rejected': 'reject',
      'scheduled': 'schedule',
      'completed': 'mark as completed',
      'no_show': 'mark as no-show'
    };

    const message = statusMessages[newStatus] || newStatus;
    if (!confirm(`Are you sure you want to ${message} this appointment?`)) {
      return;
    }

    try {
      const response = await fetch(`/api/appointments/${appointmentId}/update-status/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `status=${newStatus}`
      });

      const data = await response.json();

      if (response.ok && data.success) {
        showNotification(`Appointment ${newStatus} successfully!`, 'success');
        
        // Update UI
        updateAppointmentUI(appointmentId, newStatus);
      } else {
        showNotification(data.error || `Failed to ${message} appointment`, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('An error occurred while updating the appointment', 'error');
    }
  }

    // Update appointment UI after status change
  function updateAppointmentUI(appointmentId, newStatus) {
    // Find appointment card by appointment ID
    const card = document.querySelector(`.appointment-item[data-id="${appointmentId}"]`);
    if (!card) return;

    // Update status badge - find the span that contains status text
    const statusBadge = card.querySelector('span[class*="bg-"]');
    if (statusBadge) {
      statusBadge.textContent = getStatusDisplay(newStatus);
      statusBadge.className = `px-2 py-1 rounded-full text-xs ${getStatusClass(newStatus)}`;
    }

    // Update action buttons based on new status
    const actionDiv = card.querySelector('.flex.flex-col.space-y-2');
    if (actionDiv) {
      actionDiv.innerHTML = getActionButtons(appointmentId, newStatus);
    }

    // Update card data attribute
    card.setAttribute('data-status', newStatus);
  }

  // Get status display text
  function getStatusDisplay(status) {
    const statusMap = {
      'pending': 'Pending',
      'approved': 'Approved',
      'scheduled': 'Scheduled',
      'completed': 'Completed',
      'cancelled': 'Cancelled',
      'no_show': 'No Show',
      'rejected': 'Rejected',
      'rescheduled': 'Rescheduled'
    };
    return statusMap[status] || status;
  }

  // Get status badge color class
  function getStatusClass(status) {
    const classMap = {
      'pending': 'bg-brand-warning/10 text-brand-warning',
      'approved': 'bg-blue-100 text-blue-600',
      'scheduled': 'bg-brand-success/10 text-brand-success',
      'completed': 'bg-gray-100 text-gray-600',
      'cancelled': 'bg-brand-danger/10 text-brand-danger',
      'no_show': 'bg-orange-100 text-orange-600',
      'rejected': 'bg-red-100 text-red-600',
      'rescheduled': 'bg-purple-100 text-purple-600'
    };
    return classMap[status] || 'bg-brand-primary/10 text-brand-primary';
  }

  // Get action buttons HTML based on status
  function getActionButtons(appointmentId, status) {
    let buttons = '';

    if (status === 'pending') {
      buttons += `<button onclick="updateStatus(${appointmentId}, 'approved')" class="px-3 py-1 rounded-lg bg-brand-success/80 hover:bg-brand-success text-white transition">Approve</button>`;
      buttons += `<button onclick="updateStatus(${appointmentId}, 'rejected')" class="px-3 py-1 rounded-lg bg-brand-danger/80 hover:bg-brand-danger text-white transition">Reject</button>`;
    } else if (status === 'approved') {
      buttons += `<button onclick="updateStatus(${appointmentId}, 'scheduled')" class="px-3 py-1 rounded-lg btn-primary transition">Schedule</button>`;
    } else if (status === 'scheduled') {
      buttons += `<button onclick="updateStatus(${appointmentId}, 'completed')" class="px-3 py-1 rounded-lg bg-brand-success hover:bg-brand-success/90 text-white transition">Complete</button>`;
      buttons += `<button onclick="updateStatus(${appointmentId}, 'no_show')" class="px-3 py-1 rounded-lg bg-gray-500 hover:bg-gray-400 text-white transition">No Show</button>`;
    }

    buttons += `<button onclick="viewDetails(${appointmentId})" class="px-3 py-1 rounded-lg bg-brand-accent text-brand-primary hover:bg-brand-accent/80 transition">Details</button>`;

    return buttons;
  }

  // View appointment details in modal
  async function viewDetails(appointmentId) {
    try {
      const response = await fetch(`/api/appointments/${appointmentId}/details/`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      const data = await response.json();

      if (response.ok && data.success) {
        const appointment = data.appointment;
        
        // Create and show modal
        showDetailsModal(appointment);
      } else {
        showNotification(data.error || 'Failed to load appointment details', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('An error occurred while loading appointment details', 'error');
    }
  }

  // Show details modal
  function showDetailsModal(appointment) {
    const modalHtml = `
      <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-brand-accent flex justify-between items-center">
            <h3 class="text-xl font-semibold text-textc-main">Appointment Details</h3>
            <button onclick="closeModal()" class="text-textc-muted hover:text-textc-main">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-textc-muted">Patient Name</p>
                <p class="font-medium text-textc-main">${appointment.patient_name}</p>
              </div>
              <div>
                <p class="text-sm text-textc-muted">Status</p>
                <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(appointment.status)}">${getStatusDisplay(appointment.status)}</span>
              </div>
              <div>
                <p class="text-sm text-textc-muted">Date</p>
                <p class="font-medium text-textc-main">${appointment.appointment_date}</p>
              </div>
              <div>
                <p class="text-sm text-textc-muted">Time</p>
                <p class="font-medium text-textc-main">${appointment.appointment_time}</p>
              </div>
              <div>
                <p class="text-sm text-textc-muted">Email</p>
                <p class="font-medium text-textc-main">${appointment.patient_email}</p>
              </div>
              <div>
                <p class="text-sm text-textc-muted">Phone</p>
                <p class="font-medium text-textc-main">${appointment.patient_phone || 'N/A'}</p>
              </div>
            </div>
            ${appointment.reason ? `
            <div>
              <p class="text-sm text-textc-muted">Reason</p>
              <p class="text-textc-main">${appointment.reason}</p>
            </div>
            ` : ''}
            ${appointment.notes ? `
            <div>
              <p class="text-sm text-textc-muted">Notes</p>
              <p class="text-textc-main">${appointment.notes}</p>
            </div>
            ` : ''}
            <div>
              <p class="text-sm text-textc-muted">Priority</p>
              <span class="px-2 py-1 text-xs rounded-full bg-brand-warning/10 text-brand-warning">${appointment.priority}</span>
            </div>
            <div>
              <p class="text-sm text-textc-muted">Created</p>
              <p class="text-textc-main">${appointment.created_at}</p>
            </div>
          </div>
          <div class="p-6 border-t border-brand-accent flex justify-end">
            <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-brand-accent text-brand-primary hover:bg-brand-accent/80 transition">
              Close
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }

  // Close modal
  function closeModal() {
    const modal = document.getElementById('appointmentModal');
    if (modal) {
      modal.remove();
    }
  }

  // Mark all notifications as read
  async function markAllRead() {
    try {
      const response = await fetch('/api/notifications/mark-all-read/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (response.ok) {
        showNotification('All notifications marked as read', 'success');
        
        // Update UI - remove notification highlights
        const notificationItems = document.querySelectorAll('.bg-brand-surface');
        notificationItems.forEach(item => {
          item.classList.remove('bg-brand-primary/5');
        });
      } else {
        showNotification('Failed to mark notifications as read', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('An error occurred', 'error');
    }
  }

  // Show notification toast
  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ${type === 'success' ? 'bg-brand-success text-white' : 'bg-brand-danger text-white'}`;
    notification.innerHTML = `
      <div class="flex items-center">
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  // Get CSRF token for Django
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

{% endblock %}