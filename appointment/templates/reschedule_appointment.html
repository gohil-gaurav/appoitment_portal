{% extends 'base_enhanced.html' %}

{% block content %}
<div class="max-w-5xl mx-auto px-4">

  <!-- Header -->
  <div class="mb-10 text-center">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-brand-primary/10 rounded-full mb-4">
      <i class="fas fa-calendar-alt text-brand-primary text-2xl"></i>
    </div>
    <h1 class="text-4xl font-bold text-textc-main mb-3">Reschedule Appointment</h1>
    <p class="text-textc-muted text-lg max-w-2xl mx-auto">
      Choose a new date and time for your appointment with {{ appointment.doctor.name }}
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left: Appointment Summary -->
    <div class="space-y-6">

      <!-- Current Appointment -->
      <div class="card-style p-6">
        <h2 class="text-xl font-semibold text-textc-main mb-6 flex items-center">
          <i class="fas fa-calendar text-brand-primary mr-3"></i>
          Current Appointment
        </h2>

        <div class="space-y-4">
          <div class="bg-brand-surface rounded-lg p-4 border border-brand-accent">
            <div class="flex items-start space-x-4">
              <div class="w-12 h-12 bg-brand-primary/10 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-user-md text-brand-primary"></i>
              </div>
              <div>
                <p class="text-textc-muted text-sm">Doctor</p>
                <p class="text-textc-main font-semibold text-lg">{{ appointment.doctor.name }}</p>
                <p class="text-textc-muted">{{ appointment.doctor.specialization }}</p>
              </div>
            </div>
          </div>

          <div class="bg-brand-surface rounded-lg p-4 border border-brand-accent">
            <div class="flex items-center space-x-3 mb-2">
              <i class="fas fa-calendar-alt text-brand-primary"></i>
              <p class="text-textc-muted text-sm">Date & Time</p>
            </div>
            <p class="text-textc-main font-semibold text-lg">
              {{ appointment.appointment_date }}
            </p>
            <p class="text-brand-primary font-medium">
              at {{ appointment.appointment_time }}
            </p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-brand-surface rounded-lg p-4 border border-brand-accent">
              <p class="text-textc-muted text-sm mb-2">Status</p>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                {% if appointment.status == 'pending' %}bg-brand-warning/10 text-brand-warning
                {% elif appointment.status == 'approved' %}bg-blue-500/10 text-blue-500
                {% elif appointment.status == 'scheduled' %}bg-brand-success/10 text-brand-success
                {% else %}bg-gray-400/10 text-gray-400{% endif %}">
                {{ appointment.get_status_display }}
              </span>
            </div>

            <div class="bg-brand-surface rounded-lg p-4 border border-brand-accent">
              <p class="text-textc-muted text-sm mb-2">Priority</p>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                {% if appointment.priority == 'urgent' %}bg-brand-danger/10 text-brand-danger
                {% elif appointment.priority == 'high' %}bg-brand-warning/10 text-brand-warning
                {% else %}bg-blue-500/10 text-blue-500{% endif %}">
                {{ appointment.get_priority_display }}
              </span>
            </div>
          </div>

          {% if appointment.reason %}
          <div class="bg-brand-surface rounded-lg p-4 border border-brand-accent">
            <div class="flex items-center space-x-3 mb-2">
              <i class="fas fa-stethoscope text-brand-primary"></i>
              <p class="text-textc-muted text-sm">Reason</p>
            </div>
            <p class="text-textc-muted">{{ appointment.reason }}</p>
          </div>
          {% endif %}
        </div>
      </div>

    </div>

    <!-- Right: Reschedule Form -->
    <div class="lg:col-span-2">
      <div class="card-style p-8">

        <!-- Messages -->
        {% if messages %}
        <div class="mb-6">
          {% for message in messages %}
          <div class="p-4 rounded-lg text-sm mb-3
                {% if message.tags == 'error' %}
                  bg-brand-danger/10 text-brand-danger border border-brand-danger/30
                {% else %}
                  bg-brand-success/10 text-brand-success border border-brand-success/30
                {% endif %}
              ">
            <i
              class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% else %}check-circle{% endif %} mr-2"></i>
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <form method="POST" id="rescheduleForm" class="space-y-6">
          {% csrf_token %}

          <!-- Rescheduling Info -->
          <div class="bg-brand-primary/5 border border-brand-primary/20 rounded-lg p-4 mb-6">
            <div class="flex items-start space-x-3">
              <i class="fas fa-info-circle text-brand-primary text-lg mt-0.5"></i>
              <div>
                <h4 class="text-textc-main font-semibold mb-1">Rescheduling Information</h4>
                <p class="text-sm text-textc-muted leading-relaxed">
                  You can reschedule your appointment up to 24 hours before the original appointment time.
                  All changes will be reflected in your appointment history.
                </p>
              </div>
            </div>
          </div>

          <!-- Date Selection -->
          <div>
            <label class="block text-sm font-medium text-textc-muted mb-3">
              <i class="fas fa-calendar text-brand-primary mr-2"></i>
              Select New Date *
            </label>
            <input type="date" name="date" id="appointmentDate" min="{% now 'Y-m-d' %}" required
              onchange="loadAvailableSlots()" class="w-full px-4 py-3 bg-brand-surface border border-brand-accent rounded-lg text-textc-main
                     focus:outline-none focus:border-brand-primary transition">
            <p class="text-xs text-textc-muted mt-1">
              <i class="fas fa-info-circle mr-1"></i>
              Choose a date to see available time slots
            </p>
          </div>

          <!-- Time Slots -->
          <div>
            <label class="block text-sm font-medium text-textc-muted mb-3">
              <i class="fas fa-clock text-brand-primary mr-2"></i>
              Available Time Slots *
            </label>
            <div id="timeSlotsContainer">
              <div class="p-4 bg-brand-surface rounded-lg border border-brand-accent text-center text-textc-muted">
                <i class="fas fa-calendar-times mr-2"></i>
                Please select a date first to view available slots
              </div>
            </div>
            <input type="hidden" name="time" id="selectedTime" required>
            <p class="text-xs text-textc-muted mt-1">
              <i class="fas fa-lightbulb mr-1"></i>
              Click on a time slot to select it
            </p>
          </div>

          <!-- Reason -->
          <div>
            <label class="block text-sm font-medium text-textc-muted mb-3">
              <i class="fas fa-comment text-brand-primary mr-2"></i>
              Reason for Rescheduling (Optional)
            </label>
            <textarea name="reason" rows="4" class="w-full px-4 py-3 bg-brand-surface border border-brand-accent rounded-lg text-textc-main
                     focus:outline-none focus:border-brand-primary transition resize-none"
              placeholder="Please explain why you need to reschedule this appointment..."></textarea>
          </div>

          <!-- Comparison Info -->
          <div id="comparisonInfo" class="hidden">
            <div class="bg-brand-surface border border-brand-accent rounded-lg p-4">
              <h4 class="text-textc-main font-semibold mb-3 flex items-center">
                <i class="fas fa-exchange-alt text-brand-primary mr-2"></i>
                Schedule Comparison
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p class="text-xs text-textc-muted mb-1">Original</p>
                  <p class="text-textc-main text-sm font-medium">
                    {{ appointment.appointment_date }} at {{ appointment.appointment_time }}
                  </p>
                </div>
                <div>
                  <p class="text-xs text-textc-muted mb-1">New</p>
                  <p id="newSchedule" class="text-brand-primary text-sm font-medium">
                    Select date and time above
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Policy -->
          <div class="bg-brand-primary/5 border border-brand-primary/20 rounded-lg p-4">
            <h4 class="text-brand-primary font-semibold mb-3 flex items-center">
              <i class="fas fa-shield-alt mr-2"></i>
              Rescheduling Policy
            </h4>
            <ul class="text-sm text-textc-muted space-y-2">
              <li class="flex items-start">
                <i class="fas fa-check text-brand-primary mr-2 mt-0.5"></i>
                <span>Must be rescheduled at least 24 hours in advance</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-brand-primary mr-2 mt-0.5"></i>
                <span>Time slot availability may vary by date</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-brand-primary mr-2 mt-0.5"></i>
                <span>Doctor approval may be required for changes</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-brand-primary mr-2 mt-0.5"></i>
                <span>You will receive confirmation via email</span>
              </li>
            </ul>
          </div>

          <!-- Actions -->
          <div class="flex justify-between gap-4 pt-6 border-t border-brand-accent">
            <a href="{% url 'patient_dashboard' %}" class="px-6 py-3 bg-brand-accent text-brand-primary rounded-lg font-semibold 
                     transition-all duration-200 flex items-center hover:bg-brand-accent/80">
              <i class="fas fa-arrow-left mr-2"></i>
              Back to Dashboard
            </a>
            <button type="submit" id="submitBtn" disabled class="px-8 py-3 btn-primary font-bold rounded-lg transition-all duration-200
                     disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
              <i class="fas fa-calendar-check mr-2"></i>
              Confirm Reschedule
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/30 hidden z-50 flex items-center justify-center">
  <div class="card-style p-6 text-center">
    <div class="animate-spin h-10 w-10 border-4 border-brand-primary border-t-transparent rounded-full mx-auto mb-3">
    </div>
    <p class="text-textc-main text-sm">Checking availabilityâ€¦</p>
  </div>
</div>

<script>
  let doctorId = {{ appointment.doctor.id }};
  let originalDate = "{{ appointment.appointment_date }}";
  let originalTime = "{{ appointment.appointment_time }}";

  async function loadAvailableSlots() {
    const dateInput = document.getElementById('appointmentDate');
    const timeSlotsContainer = document.getElementById('timeSlotsContainer');
    const selectedTimeInput = document.getElementById('selectedTime');
    const submitBtn = document.getElementById('submitBtn');
    const comparisonInfo = document.getElementById('comparisonInfo');

    // Clear previous selection
    selectedTimeInput.value = '';
    submitBtn.disabled = true;
    comparisonInfo.classList.add('hidden');

    if (!dateInput.value) {
      timeSlotsContainer.innerHTML = `
            <div class="p-4 bg-brand-surface rounded-lg border border-brand-accent text-center text-textc-muted">
                <i class="fas fa-calendar-times mr-2"></i>
                Please select a date first to view available slots
            </div>
        `;
      return;
    }

    showLoading(true);

    try {
      const response = await fetch(`/api/appointments/available-slots/?doctor_id=${doctorId}&date=${dateInput.value}`);
      const data = await response.json();

      if (data.slots && data.slots.length > 0) {
        const slotsGrid = document.createElement('div');
        slotsGrid.className = 'grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3';

        data.slots.forEach(slot => {
          const slotButton = document.createElement('button');
          slotButton.type = 'button';
          slotButton.className = 'time-slot-btn px-4 py-3 bg-brand-surface border border-brand-accent rounded-lg text-textc-main hover:bg-brand-primary/10 hover:border-brand-primary transition-all duration-200 cursor-pointer';
          slotButton.textContent = slot;
          slotButton.dataset.time = slot;
          slotButton.onclick = () => selectTimeSlot(slot, slotButton);

          slotsGrid.appendChild(slotButton);
        });

        timeSlotsContainer.innerHTML = '';
        timeSlotsContainer.appendChild(slotsGrid);
      } else {
        timeSlotsContainer.innerHTML = `
                <div class="p-6 bg-brand-surface rounded-lg border border-brand-accent text-center">
                    <i class="fas fa-calendar-times text-textc-muted text-2xl mb-3"></i>
                    <p class="text-textc-muted font-medium">No available slots</p>
                    <p class="text-sm text-textc-muted/70 mt-1">Try selecting a different date</p>
                </div>
            `;
      }
    } catch (error) {
      console.error('Error loading slots:', error);
      timeSlotsContainer.innerHTML = `
            <div class="p-4 bg-brand-danger/10 border border-brand-danger/30 rounded-lg text-center">
                <i class="fas fa-exclamation-triangle text-brand-danger mr-2"></i>
                <span class="text-brand-danger">Error loading available slots. Please try again.</span>
            </div>
        `;
    } finally {
      showLoading(false);
    }
  }

  function selectTimeSlot(time, buttonElement) {
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
      btn.classList.remove('bg-brand-primary/20', 'border-brand-primary');
      btn.classList.add('hover:bg-brand-primary/10', 'hover:border-brand-primary');
    });

    buttonElement.classList.remove('hover:bg-brand-primary/10', 'hover:border-brand-primary');
    buttonElement.classList.add('bg-brand-primary/20', 'border-brand-primary');

    document.getElementById('selectedTime').value = time;
    document.getElementById('submitBtn').disabled = false;

    const comparisonInfo = document.getElementById('comparisonInfo');
    const newSchedule = document.getElementById('newSchedule');
    const dateInput = document.getElementById('appointmentDate');

    newSchedule.textContent = `${dateInput.value} at ${time}`;
    comparisonInfo.classList.remove('hidden');
  }

  function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
      overlay.classList.remove('hidden');
    } else {
      overlay.classList.add('hidden');
    }
  }

  document.getElementById('rescheduleForm')?.addEventListener('submit', function (e) {
    const submitBtn = document.getElementById('submitBtn');
    const selectedTime = document.getElementById('selectedTime').value;
    const selectedDate = document.getElementById('appointmentDate').value;

    if (!selectedTime || !selectedDate) {
      e.preventDefault();
      alert('Please select both date and time before submitting.');
      return;
    }

    if (!confirm(`Are you sure you want to reschedule your appointment?\n\nFrom: ${originalDate} at ${originalTime}\nTo: ${selectedDate} at ${selectedTime}`)) {
      e.preventDefault();
      return;
    }

    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Rescheduling...';
    submitBtn.disabled = true;
  });

  document.addEventListener('DOMContentLoaded', function () {
    const dateInput = document.getElementById('appointmentDate');
    if (dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.min = today;
    }
  });
</script>
{% endblock %}